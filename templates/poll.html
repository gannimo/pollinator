<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poll {{POLL_ID}}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:900px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
    .box{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    .muted{color:#666}
    .opt{display:flex;gap:10px;align-items:flex-start;margin:10px 0}
    .lab *{margin:0}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button:hover{background:#f6f6f6}
    textarea{width:100%;min-height:110px}
    code{background:#f7f7f7;padding:2px 6px;border-radius:8px}
    #qr{image-rendering:pixelated}
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="muted">Poll link</div>
      <div><code id="pollUrl"></code></div>
      <div class="muted" style="margin-top:6px">
        Expires (unix): <code>{{EXPIRES_AT}}</code>
      </div>
    </div>
    <div>
      <div class="muted">Live results</div>
      <div><a href="/p/{{POLL_ID}}/results">/p/{{POLL_ID}}/results</a></div>
      <div class="muted" style="margin-top:8px">Download</div>
      <div>
        <a href="/p/{{POLL_ID}}/download.json">JSON</a> ·
        <a href="/p/{{POLL_ID}}/download.csv">CSV</a>
      </div>
    </div>
  </div>

  <div class="box">
    {{QUESTION_HTML}}
  </div>

  <form id="voteForm" class="box">
    <h3>Choose one</h3>
    {{OPTIONS_HTML}}
    {{FREE_TEXT_BLOCK}}
    <button type="submit">Submit</button>
    <span id="status" class="muted" style="margin-left:10px"></span>
  </form>

  <div class="box">
    <h3>QR code</h3>
    <img id="qr" alt="QR Code" src="/p/{{POLL_ID}}/qr.png" />
  </div>

<script>
(function() {
  const pollId = "{{POLL_ID}}";
  const pollUrl = {{POLL_URL_EXPR}};
  document.getElementById("pollUrl").textContent = pollUrl;

  const ft = document.getElementById("freeText");
  const ftCount = document.getElementById("ftCount");
  if (ft && ftCount) {
    const maxLen = ft.getAttribute("maxlength") ? parseInt(ft.getAttribute("maxlength"), 10) : 0;
    const update = () => {
      const n = (ft.value || "").length;
      ftCount.textContent = maxLen ? (n + " / " + maxLen) : (n + " chars");
    };
    ft.addEventListener("input", update);
    update();
  }

  document.getElementById("voteForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const status = document.getElementById("status");
    status.textContent = "Submitting...";
    const opt = document.querySelector('input[name="option"]:checked');
    const payload = {
      option_id: opt ? opt.value : null,
      free_text: ft ? ft.value : ""
    };
    try {
      const r = await fetch("/p/" + pollId + "/vote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || "Failed");
      status.textContent = "Thanks! ✓";
      if (ft) ft.value = "";
      if (opt) opt.checked = false;
      if (ftCount && ft) ftCount.textContent = ((ft.value||"").length) + " chars";
    } catch (err) {
      status.textContent = "Error: " + err.message;
    }
  });
})();
</script>

</body>
</html>

